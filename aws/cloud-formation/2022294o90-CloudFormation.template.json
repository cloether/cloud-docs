{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Cross Cloud Security Center IAM Role to set read permissions",
  "Parameters":{
    "CspmMonitorAwsRoleName":{
      "Type":"String",
      "Description":"Provide a role ARN name (Example: CspmMonitorAws) for CSPM offering",
      "AllowedPattern":"[-_a-zA-Z0-9]+",
      "Default":"CspmMonitorAws"
    },
    "DefenderForServersVmScannerRoleName":{
      "Type":"String",
      "Description":"Provide a role ARN name DefenderForCloud-AgentlessScanner for Servers agentless scanning offering",
      "AllowedPattern":"[-_a-zA-Z0-9]+",
      "Default":"DefenderForCloud-AgentlessScanner"
    }
  },
  "Conditions":{},
  "Resources":{
    "ASCDefendersOIDCIdentityProvider":{
      "Description":"Identity provider resource using for MDC authentication with the required thumbprint list and the issuer url",
      "Type":"AWS::IAM::OIDCProvider",
      "Properties":{
        "ClientIdList":[
          "api://4d8bed1f-eee7-4d8e-b0dc-8462049a4479",
          "api://AzureSecurityCenter.MultiCloud.DefenderForServers.VmScanner"
        ],
        "ThumbprintList":[
          "626d44e704d1ceabe3bf0d53397464ac8080142c"
        ],
        "Url":"https://sts.windows.net/33e01921-4d64-4f8c-a055-5bdaffd5e33d/"
      }
    },
    "CspmMonitorAwsRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
        "Description":"MDC - CSPM ready only role",
        "ManagedPolicyArns":[
          "arn:aws:iam::aws:policy/ReadOnlyAccess"
        ],
        "AssumeRolePolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Principal":{
                "Federated":{
                  "Fn::Sub":"arn:aws:iam::${AWS::AccountId}:oidc-provider/sts.windows.net/33e01921-4d64-4f8c-a055-5bdaffd5e33d/"
                }
              },
              "Action":"sts:AssumeRoleWithWebIdentity",
              "Condition":{
                "StringEquals":{
                  "sts.windows.net/33e01921-4d64-4f8c-a055-5bdaffd5e33d/:aud":"api://4d8bed1f-eee7-4d8e-b0dc-8462049a4479",
                  "sts:RoleSessionName":"MicrosoftDefenderForClouds_33dcc724-ac62-4e26-8eda-e1a7a586c302"
                }
              }
            }
          ]
        },
        "Policies":[
          {
            "PolicyName":{
              "Ref":"CspmMonitorAwsRoleName"
            },
            "PolicyDocument":{
              "Version":"2012-10-17",
              "Statement":[
                {
                  "Effect":"Deny",
                  "Action":[
                    "aws-portal:*",
                    "cur:*"
                  ],
                  "Resource":"*"
                }
              ]
            }
          }
        ],
        "RoleName":{
          "Ref":"CspmMonitorAwsRoleName"
        }
      }
    },
    "DefenderForServersVmScannerRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
        "Description":"Azure Security Center - Defender For Servers VmScanner role",
        "ManagedPolicyArns":[],
        "AssumeRolePolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Principal":{
                "Federated":{
                  "Fn::Sub":"arn:aws:iam::${AWS::AccountId}:oidc-provider/sts.windows.net/33e01921-4d64-4f8c-a055-5bdaffd5e33d/"
                }
              },
              "Action":"sts:AssumeRoleWithWebIdentity",
              "Condition":{
                "StringEquals":{
                  "sts.windows.net/33e01921-4d64-4f8c-a055-5bdaffd5e33d/:aud":"api://AzureSecurityCenter.MultiCloud.DefenderForServers.VmScanner",
                  "sts:RoleSessionName":"MicrosoftDefenderForClouds_33dcc724-ac62-4e26-8eda-e1a7a586c302"
                }
              }
            }
          ]
        },
        "Policies":[
          {
            "PolicyName":"AzureSecurityCenter_DefenderForServers_VmScanner",
            "PolicyDocument":{
              "Version":"2012-10-17",
              "Statement":[
                {
                  "Sid":"VmScannerDeleteSnapshotAccess",
                  "Effect":"Allow",
                  "Action":"ec2:DeleteSnapshot",
                  "Resource":"arn:aws:ec2:*::snapshot/*",
                  "Condition":{
                    "StringEquals":{
                      "ec2:ResourceTag/CreatedBy":"Microsoft Defender for Cloud"
                    }
                  }
                },
                {
                  "Sid":"VmScannerAccess",
                  "Effect":"Allow",
                  "Action":[
                    "ec2:ModifySnapshotAttribute",
                    "ec2:DeleteTags",
                    "ec2:CreateTags",
                    "ec2:CreateSnapshots",
                    "ec2:CreateSnapshot"
                  ],
                  "Resource":[
                    "arn:aws:ec2:*:*:instance/*",
                    "arn:aws:ec2:*::snapshot/*",
                    "arn:aws:ec2:*:*:volume/*"
                  ]
                },
                {
                  "Sid":"VmScannerVerificationAccess",
                  "Effect":"Allow",
                  "Action":[
                    "ec2:DescribeSnapshots",
                    "ec2:DescribeInstanceStatus"
                  ],
                  "Resource":"*"
                }
              ]
            }
          }
        ],
        "RoleName":{
          "Ref":"DefenderForServersVmScannerRoleName"
        }
      }
    }
  },
  "Outputs":{
    "CrossCloudSecurityCenterReadOnlyARN":{
      "Value":{
        "Fn::GetAtt":[
          "CspmMonitorAwsRole",
          "Arn"
        ]
      },
      "Description":"Role ARN for CSPM offering"
    },
    "DefenderForServersVmScannerRoleARN":{
      "Value":{
        "Fn::GetAtt":[
          "DefenderForServersVmScannerRole",
          "Arn"
        ]
      },
      "Description":"Role ARN for VmScanner offering"
    }
  }
}
